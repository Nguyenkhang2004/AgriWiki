@page
@model AgriWiki_Project.Pages.Search
@{
    ViewData["Title"] = "Search";
}
<link rel="stylesheet" href="~/css/search.css">
<div class="container">
    <div class="row">
        <!-- Sidebar - Bộ lọc -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="sidebar">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Bộ lọc</h5>
                    <button class="btn btn-sm btn-link text-danger p-0" id="clearAllBtn" style="display: none;">
                        Xóa tất cả
                    </button>
                </div>

                <!-- Danh mục -->
                <div class="filter-section">
                    <div class="filter-title">
                        <i class="bi bi-grid me-1"></i>Danh mục
                    </div>
                    <div id="categoryFilters"></div>
                </div>

                <hr>

                <!-- Điều kiện ánh sáng -->
                <div class="filter-section">
                    <div class="filter-title">
                        <i class="bi bi-sun me-1"></i>Điều kiện ánh sáng
                    </div>
                    <div id="sunlightFilters"></div>
                </div>

                <hr>

                <!-- Loại đất -->
                <div class="filter-section">
                    <div class="filter-title">
                        <i class="bi bi-droplet me-1"></i>Loại đất
                    </div>
                    <div id="soilFilters"></div>
                </div>

                <!-- Active Filters Summary -->
                <div id="activeFilters" class="active-filters mt-4" style="display: none;">
                    <p class="small fw-bold mb-2">Đang lọc theo:</p>
                    <div id="activeFilterTags"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <!-- Search Box -->
            <div class="search-box p-3">
                <div class="position-relative">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="form-control search-input" id="searchInput"
                        placeholder="Tìm kiếm theo tên cây hoặc tên khoa học...">
                </div>
            </div>

            <!-- Results Count -->
            <div class="mb-3">
                <p class="text-muted">
                    Tìm thấy <span class="fw-bold text-success" id="resultsCount">0</span> kết quả
                </p>
            </div>

            <!-- Results Grid -->
            <div class="row g-4" id="plantsGrid"></div>

            <!-- No Results -->
            <div class="no-results" id="noResults" style="display: none;">
                <i class="bi bi-search" style="font-size: 4rem; color: #ccc;"></i>
                <h4 class="mt-3">Không tìm thấy kết quả</h4>
                <p class="text-muted">Thử điều chỉnh bộ lọc hoặc từ khóa tìm kiếm của bạn</p>
                <button class="btn btn-success" id="clearFiltersBtn" style="display: none;">
                    Xóa bộ lọc
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Mock Data
    const categories = [
        { category_id: 1, name: 'Cây ăn quả' },
        { category_id: 2, name: 'Cây công nghiệp' },
        { category_id: 3, name: 'Cây rau' },
        { category_id: 4, name: 'Cây cảnh' },
        { category_id: 5, name: 'Cây thuốc' }
    ];

    const plants = [
        {
            plant_id: 1,
            name: 'Cà chua',
            scientific_name: 'Solanum lycopersicum',
            category: 'Cây rau',
            description: 'Cây cà chua là loại cây trồng phổ biến, cho quả đỏ giàu vitamin C',
            image_url: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?w=400',
            temperature_range: '20-30°C',
            sunlight: 'Ánh sáng mặt trời đầy đủ',
            soil_type: 'Đất tơi xốp'
        },
        {
            plant_id: 2,
            name: 'Hoa hồng',
            scientific_name: 'Rosa',
            category: 'Cây cảnh',
            description: 'Cây hoa hồng là loại hoa cảnh đẹp, có nhiều màu sắc khác nhau',
            image_url: 'https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=400',
            temperature_range: '15-25°C',
            sunlight: 'Ánh sáng gián tiếp',
            soil_type: 'Đất giàu dinh dưỡng'
        },
        {
            plant_id: 3,
            name: 'Xoài',
            scientific_name: 'Mangifera indica',
            category: 'Cây ăn quả',
            description: 'Cây ăn quả nhiệt đới cho quả ngọt, giàu vitamin A',
            image_url: 'https://images.unsplash.com/photo-1601493700631-2b16ec4b4716?w=400',
            temperature_range: '24-30°C',
            sunlight: 'Ánh sáng mặt trời đầy đủ',
            soil_type: 'Đất thịt pha cát'
        },
        {
            plant_id: 4,
            name: 'Húng quế',
            scientific_name: 'Ocimum basilicum',
            category: 'Cây thuốc',
            description: 'Cây gia vị có mùi thơm đặc trưng, dùng trong ẩm thực và y học',
            image_url: 'https://images.unsplash.com/photo-1618375569909-3c8616cf7733?w=400',
            temperature_range: '18-28°C',
            sunlight: 'Ánh sáng đầy đủ',
            soil_type: 'Đất tơi xốp'
        },
        {
            plant_id: 5,
            name: 'Cà phê',
            scientific_name: 'Coffea arabica',
            category: 'Cây công nghiệp',
            description: 'Cây công nghiệp quan trọng, hạt dùng để pha chế cà phê',
            image_url: 'https://images.unsplash.com/photo-1559056199-641a0ac8b55e?w=400',
            temperature_range: '15-24°C',
            sunlight: 'Bóng râm',
            soil_type: 'Đất cát'
        },
        {
            plant_id: 6,
            name: 'Dừa',
            scientific_name: 'Cocos nucifera',
            category: 'Cây công nghiệp',
            description: 'Cây nhiệt đới có nhiều công dụng, từ nước đến dầu dừa',
            image_url: 'https://images.unsplash.com/photo-1598449356475-b9f71db7d847?w=400',
            temperature_range: '27-35°C',
            sunlight: 'Ánh sáng mặt trời đầy đủ',
            soil_type: 'Đất cát'
        }
    ];

    const sunlightOptions = [...new Set(plants.map(p => p.sunlight))];
    const soilTypeOptions = [...new Set(plants.map(p => p.soil_type))];

    // State
    let filters = {
        search: '',
        category: '',
        sunlight: '',
        soilType: ''
    };

    // Initialize
    function init() {
        renderCategoryFilters();
        renderSunlightFilters();
        renderSoilFilters();
        renderPlants();
        attachEventListeners();
    }

    function renderCategoryFilters() {
        const container = document.getElementById('categoryFilters');
        let html = `
                <div class="filter-option">
                    <input type="radio" name="category" value="" id="cat_all" checked>
                    <label for="cat_all" class="ms-2">Tất cả</label>
                </div>
            `;
        categories.forEach(cat => {
            html += `
                    <div class="filter-option">
                        <input type="radio" name="category" value="${cat.name}" id="cat_${cat.category_id}">
                        <label for="cat_${cat.category_id}" class="ms-2">${cat.name}</label>
                    </div>
                `;
        });
        container.innerHTML = html;
    }

    function renderSunlightFilters() {
        const container = document.getElementById('sunlightFilters');
        let html = `
                <div class="filter-option">
                    <input type="radio" name="sunlight" value="" id="sun_all" checked>
                    <label for="sun_all" class="ms-2">Tất cả</label>
                </div>
            `;
        sunlightOptions.forEach((option, index) => {
            html += `
                    <div class="filter-option">
                        <input type="radio" name="sunlight" value="${option}" id="sun_${index}">
                        <label for="sun_${index}" class="ms-2 small">${option}</label>
                    </div>
                `;
        });
        container.innerHTML = html;
    }

    function renderSoilFilters() {
        const container = document.getElementById('soilFilters');
        let html = `
                <div class="filter-option">
                    <input type="radio" name="soilType" value="" id="soil_all" checked>
                    <label for="soil_all" class="ms-2">Tất cả</label>
                </div>
            `;
        soilTypeOptions.forEach((option, index) => {
            html += `
                    <div class="filter-option">
                        <input type="radio" name="soilType" value="${option}" id="soil_${index}">
                        <label for="soil_${index}" class="ms-2 small">${option}</label>
                    </div>
                `;
        });
        container.innerHTML = html;
    }

    function getFilteredPlants() {
        return plants.filter(plant => {
            const matchSearch = !filters.search ||
                plant.name.toLowerCase().includes(filters.search.toLowerCase()) ||
                plant.scientific_name.toLowerCase().includes(filters.search.toLowerCase());

            const matchCategory = !filters.category || plant.category === filters.category;
            const matchSunlight = !filters.sunlight || plant.sunlight === filters.sunlight;
            const matchSoil = !filters.soilType || plant.soil_type === filters.soilType;

            return matchSearch && matchCategory && matchSunlight && matchSoil;
        });
    }

    function renderPlants() {
        const filteredPlants = getFilteredPlants();
        const container = document.getElementById('plantsGrid');
        const noResults = document.getElementById('noResults');
        const resultsCount = document.getElementById('resultsCount');

        resultsCount.textContent = filteredPlants.length;

        if (filteredPlants.length === 0) {
            container.innerHTML = '';
            noResults.style.display = 'block';
            const hasFilters = filters.category || filters.sunlight || filters.soilType;
            document.getElementById('clearFiltersBtn').style.display = hasFilters ? 'inline-block' : 'none';
        } else {
            noResults.style.display = 'none';
            let html = '';
            filteredPlants.forEach(plant => {
                html += `
                        <div class="col-lg-4 col-md-6">
                            <div class="plant-card">
                                <img src="${plant.image_url}" alt="${plant.name}" class="plant-image">
                                <div class="p-3">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="mb-0">${plant.name}</h5>
                                        <span class="plant-category">${plant.category}</span>
                                    </div>
                                    <p class="small text-muted fst-italic mb-2">${plant.scientific_name}</p>
                                    <p class="small text-secondary mb-3">${plant.description}</p>
                                    
                                    <div class="mb-3">
                                        <div class="condition-badge mb-2">
                                            <i class="bi bi-thermometer-half text-warning"></i>
                                            <span>${plant.temperature_range}</span>
                                        </div>
                                        <div class="condition-badge mb-2">
                                            <i class="bi bi-sun text-warning"></i>
                                            <span class="text-truncate">${plant.sunlight}</span>
                                        </div>
                                        <div class="condition-badge">
                                            <i class="bi bi-droplet text-primary"></i>
                                            <span>${plant.soil_type}</span>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-detail w-100">Xem chi tiết</button>
                                </div>
                            </div>
                        </div>
                    `;
            });
            container.innerHTML = html;
        }

        updateActiveFilters();
    }

    function updateActiveFilters() {
        const hasFilters = filters.category || filters.sunlight || filters.soilType;
        const activeFiltersDiv = document.getElementById('activeFilters');
        const clearAllBtn = document.getElementById('clearAllBtn');

        if (hasFilters) {
            activeFiltersDiv.style.display = 'block';
            clearAllBtn.style.display = 'block';

            let tagsHtml = '';
            if (filters.category) {
                tagsHtml += `
                        <span class="filter-tag">
                            Danh mục: ${filters.category}
                            <button class="remove-btn" onclick="removeFilter('category')">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </span>
                    `;
            }
            if (filters.sunlight) {
                tagsHtml += `
                        <span class="filter-tag">
                            Ánh sáng: ${filters.sunlight}
                            <button class="remove-btn" onclick="removeFilter('sunlight')">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </span>
                    `;
            }
            if (filters.soilType) {
                tagsHtml += `
                        <span class="filter-tag">
                            Đất: ${filters.soilType}
                            <button class="remove-btn" onclick="removeFilter('soilType')">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </span>
                    `;
            }
            document.getElementById('activeFilterTags').innerHTML = tagsHtml;
        } else {
            activeFiltersDiv.style.display = 'none';
            clearAllBtn.style.display = 'none';
        }
    }

    function removeFilter(filterType) {
        filters[filterType] = '';
        const radioName = filterType === 'soilType' ? 'soilType' : filterType;
        document.querySelector(`input[name="${radioName}"][value=""]`).checked = true;
        renderPlants();
    }

    function clearAllFilters() {
        filters = {
            search: '',
            category: '',
            sunlight: '',
            soilType: ''
        };
        document.getElementById('searchInput').value = '';
        document.querySelectorAll('input[type="radio"]').forEach(radio => {
            if (radio.value === '') radio.checked = true;
        });
        renderPlants();
    }

    function attachEventListeners() {
        // Search
        document.getElementById('searchInput').addEventListener('input', (e) => {
            filters.search = e.target.value;
            renderPlants();
        });

        // Category filters
        document.querySelectorAll('input[name="category"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                filters.category = e.target.value;
                renderPlants();
            });
        });

        // Sunlight filters
        document.querySelectorAll('input[name="sunlight"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                filters.sunlight = e.target.value;
                renderPlants();
            });
        });

        // Soil filters
        document.querySelectorAll('input[name="soilType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                filters.soilType = e.target.value;
                renderPlants();
            });
        });

        // Clear all
        document.getElementById('clearAllBtn').addEventListener('click', clearAllFilters);
        document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);
    }

    // Initialize app
    init();
</script>